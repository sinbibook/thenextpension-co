/**
 * Header & Footer Data Mapper
 * header.html, footer.html Ï†ÑÏö© Îß§Ìïë Ìï®ÏàòÎì§ÏùÑ Ìè¨Ìï®Ìïú ÌÅ¥ÎûòÏä§
 * BaseDataMapperÎ•º ÏÉÅÏÜçÎ∞õÏïÑ header/footer Í≥µÌÜµ Í∏∞Îä• Ï†úÍ≥µ
 */
class HeaderFooterMapper extends BaseDataMapper {
    constructor() {
        super();
    }

    // ============================================================================
    // üè† HEADER MAPPINGS
    // ============================================================================

    /**
     * Favicon Îß§Ìïë (homepage.images.logo Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
     */
    mapFavicon() {
        if (!this.isDataLoaded) return;

        const logoUrl = ImageHelpers.extractLogoUrl(this.data);

        if (logoUrl) {
            // Í∏∞Ï°¥ favicon ÎßÅÌÅ¨ Ï∞æÍ∏∞
            let faviconLink = document.querySelector('link[rel="icon"]');

            // ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
            if (!faviconLink) {
                faviconLink = document.createElement('link');
                faviconLink.rel = 'icon';
                document.head.appendChild(faviconLink);
            }

            // favicon URL ÏÑ§Ï†ï
            faviconLink.href = logoUrl;
        }
    }

    /**
     * Header Î°úÍ≥† Îß§Ìïë (ÌÖçÏä§Ìä∏ Î∞è Ïù¥ÎØ∏ÏßÄ)
     */
    mapHeaderLogo() {
        if (!this.isDataLoaded || !this.data.property) return;

        const property = this.data.property;

        // Header Î°úÍ≥† ÌÖçÏä§Ìä∏ Îß§Ìïë (data-logo-text ÏÜçÏÑ± ÏÇ¨Ïö©)
        const logoText = this.safeSelect('[data-logo-text]');
        if (logoText && property.name) {
            logoText.textContent = property.name;
        }

        // Header Î°úÍ≥† Ïù¥ÎØ∏ÏßÄ Îß§Ìïë (data-logo ÏÜçÏÑ± ÏÇ¨Ïö©)
        const logoImage = this.safeSelect('[data-logo]');
        if (logoImage) {
            const logoUrl = ImageHelpers.extractLogoUrl(this.data);

            if (logoUrl) {
                logoImage.onerror = () => {
                    console.warn('‚ö†Ô∏è Ìó§Îçî Î°úÍ≥† Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®');
                    ImageHelpers.applyPlaceholder(logoImage);
                };
                logoImage.src = logoUrl;
                logoImage.alt = property.name || 'Î°úÍ≥†';
                logoImage.classList.remove('empty-image-placeholder');
            } else {
                ImageHelpers.applyPlaceholder(logoImage);
            }
        }
    }

    /**
     * Header ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î©îÎâ¥ ÎèôÏ†Å ÏÉùÏÑ± (Í∞ùÏã§, ÏãúÏÑ§ Î©îÎâ¥ Îì±)
     */
    mapHeaderNavigation() {
        if (!this.isDataLoaded) return;

        // Î©îÏù∏ Î©îÎâ¥ ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ ÏÑ§Ï†ï
        this.mapMainMenuItems();

        // Í∞ùÏã§ Î©îÎâ¥ ÎèôÏ†Å ÏÉùÏÑ±
        this.mapRoomMenuItems();

        // ÏãúÏÑ§ Î©îÎâ¥ ÎèôÏ†Å ÏÉùÏÑ±
        this.mapFacilityMenuItems();

        // ÏòàÏïΩ Î≤ÑÌäºÏóê gpension_id Îß§Ìïë
        this.mapReservationButtons();
    }

    /**
     * ÏòàÏïΩ Î≤ÑÌäºÏóê gpension_id Îß§Ìïë
     */
    mapReservationButtons() {
        if (!this.isDataLoaded || !this.data.property) {
            return;
        }

        // gpension_id Ï∞æÍ∏∞ (Ïó¨Îü¨ Í≤ΩÎ°ú ÏãúÎèÑ)
        const gpensionId = this.data.property.gpension_id ||
                          this.data.property.gpensionId ||
                          this.data.gpension_id;

        if (!gpensionId) {
            return;
        }

        // Î™®Îì† ÏòàÏïΩ Î≤ÑÌäºÏóê gpension_id ÏÑ§Ï†ï
        const reservationButtons = document.querySelectorAll('[data-booking-engine]');
        reservationButtons.forEach(button => {
            button.setAttribute('data-gpension-id', gpensionId);
        });
    }

    /**
     * Î©îÏù∏ Î©îÎâ¥ ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ ÏÑ§Ï†ï
     */
    mapMainMenuItems() {
        // Spaces Î©îÎâ¥ - Ï≤´ Î≤àÏß∏ Í∞ùÏã§Î°ú Ïù¥Îèô
        const spacesMenu = document.querySelector('[data-room-link]');
        if (spacesMenu) {
            const rooms = this.safeGet(this.data, 'rooms');
            if (rooms && rooms.length > 0) {
                spacesMenu.onclick = () => {
                    window.location.href = `room.html?id=${rooms[0].id}`;
                };
            }
        }

        // Specials Î©îÎâ¥ - Ï≤´ Î≤àÏß∏ ÏãúÏÑ§Î°ú Ïù¥Îèô
        const specialsMenu = document.querySelector('[data-facility-link]');
        if (specialsMenu) {
            const facilities = this.safeGet(this.data, 'property.facilities');
            if (facilities && facilities.length > 0) {
                specialsMenu.onclick = () => {
                    window.location.href = `facility.html?id=${facilities[0].id}`;
                };
            }
        }
    }

    /**
     * Ìó¨Ìçº Î©îÏÑúÎìú: Î©îÎâ¥ ÏïÑÏù¥ÌÖúÎì§ÏùÑ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
     * @param {Array} items - Î©îÎâ¥ ÏïÑÏù¥ÌÖú Îç∞Ïù¥ÌÑ∞ Î∞∞Ïó¥
     * @param {string} classPrefix - CSS ÌÅ¥ÎûòÏä§ Ï†ëÎëêÏÇ¨ (sub-spaces-, sub-specials- Îì±)
     * @param {string} mobileContainerId - Î™®Î∞îÏùº Î©îÎâ¥ Ïª®ÌÖåÏù¥ÎÑà ID
     * @param {string} urlTemplate - URL ÌÖúÌîåÎ¶ø (room.html, facility.html Îì±)
     * @param {string} defaultNamePrefix - Í∏∞Î≥∏ Ïù¥Î¶Ñ Ï†ëÎëêÏÇ¨ (Í∞ùÏã§, ÏãúÏÑ§ Îì±)
     * @param {number} maxItems - ÏµúÎåÄ ÌëúÏãúÌï† ÏïÑÏù¥ÌÖú Ïàò (Í∏∞Î≥∏: Î¨¥Ï†úÌïú)
     * @param {Function} customClickHandler - Ïª§Ïä§ÌÖÄ ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
     */
    _createMenuItems(items, classPrefix, mobileContainerId, urlTemplate, defaultNamePrefix, maxItems = null, customClickHandler = null) {
        if (!items || !Array.isArray(items)) return;

        // Desktop ÏÑúÎ∏åÎ©îÎâ¥ ÏóÖÎç∞Ïù¥Ìä∏
        const desktopMenu = document.querySelector('.sub-menus');
        if (desktopMenu) {
            // Í∏∞Ï°¥ Î©îÎâ¥ ÏïÑÏù¥ÌÖúÎì§ Ï†úÍ±∞
            const existingItems = desktopMenu.querySelectorAll(`[class*="${classPrefix}"]`);
            existingItems.forEach(item => item.remove());

            // Î©îÎâ¥ Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ left ÏúÑÏπò Ï†ïÏùò
            const leftPositions = {
                'sub-about-': 15,
                'sub-spaces-': 121,
                'sub-specials-': 228,
                'sub-reservation-': 332
            };

            // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò left ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞
            const leftPosition = leftPositions[classPrefix] || 0;

            // ÏÉàÎ°úÏö¥ Î©îÎâ¥ ÏïÑÏù¥ÌÖúÎì§ ÏÉùÏÑ±
            const displayItems = maxItems ? items.slice(0, maxItems) : items;
            displayItems.forEach((item, index) => {
                const menuItem = document.createElement('div');
                menuItem.className = `sub-menu-item ${classPrefix}${index + 1}`;
                menuItem.textContent = item.name || `${defaultNamePrefix}${index + 1}`;

                // ÎèôÏ†ÅÏúºÎ°ú ÏúÑÏπò Í≥ÑÏÇ∞ (Ï≤´ Î≤àÏß∏: 29px, Í∑∏ Îã§ÏùåÎ∂ÄÌÑ∞ 34pxÏî© Ï¶ùÍ∞Ä)
                const topPosition = 29 + (index * 34);
                menuItem.style.cssText = `left: ${leftPosition}px; top: ${topPosition}px;`;

                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
                menuItem.addEventListener('click', () => {
                    if (customClickHandler) {
                        customClickHandler(item.id);
                    } else {
                        window.location.href = `${urlTemplate}?id=${item.id}`;
                    }
                });

                desktopMenu.appendChild(menuItem);
            });

            // ÏÑúÎ∏åÎ©îÎâ¥ Ïª®ÌÖåÏù¥ÎÑà ÎÜíÏù¥ ÎèôÏ†Å Ï°∞Ï†ï
            // Í∞ÄÏû• ÎßéÏùÄ Î©îÎâ¥Î•º Í∞ÄÏßÑ Ïπ¥ÌÖåÍ≥†Î¶¨ Í∏∞Ï§ÄÏúºÎ°ú ÎÜíÏù¥ Í≥ÑÏÇ∞
            const allSubMenuItems = desktopMenu.querySelectorAll('.sub-menu-item');
            if (allSubMenuItems.length > 0) {
                // Í∞Å Î©îÎâ¥ ÏïÑÏù¥ÌÖú Ï§ë Í∞ÄÏû• ÏïÑÎûòÏóê ÏûàÎäî Ìï≠Î™©Ïùò bottom ÏúÑÏπò Í≥ÑÏÇ∞
                let maxBottom = 0;
                allSubMenuItems.forEach(item => {
                    // inline styleÍ≥º CSSÎ°ú Ï†ïÏùòÎêú top Í∞í Î™®Îëê ÏùΩÍ∏∞
                    const computedTop = window.getComputedStyle(item).top;
                    const top = parseInt(computedTop) || parseInt(item.style.top) || 0;
                    const itemHeight = 34; // Í∞Å Î©îÎâ¥ ÏïÑÏù¥ÌÖú ÎÜíÏù¥ (padding Ìè¨Ìï®)
                    const bottom = top + itemHeight;
                    if (bottom > maxBottom) {
                        maxBottom = bottom;
                    }
                });

                // Ïó¨Ïú† Í≥µÍ∞Ñ Ï∂îÍ∞Ä (ÏÉÅÎã® 9px + ÌïòÎã® Ïó¨Ïú†)
                const containerHeight = maxBottom + 10;
                desktopMenu.style.height = `${containerHeight}px`;
            }
        }

        // Mobile ÏÑúÎ∏åÎ©îÎâ¥ ÏóÖÎç∞Ïù¥Ìä∏
        const mobileContainer = document.getElementById(mobileContainerId);
        if (mobileContainer) {
            mobileContainer.innerHTML = '';

            items.forEach((item, index) => {
                const menuButton = document.createElement('button');
                menuButton.className = 'mobile-sub-item';
                menuButton.textContent = item.name || `${defaultNamePrefix}${index + 1}`;

                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
                menuButton.addEventListener('click', () => {
                    if (customClickHandler) {
                        customClickHandler(item.id);
                    } else {
                        window.location.href = `${urlTemplate}?id=${item.id}`;
                    }
                });

                mobileContainer.appendChild(menuButton);
            });
        }
    }

    /**
     * Í∞ùÏã§ Î©îÎâ¥ ÏïÑÏù¥ÌÖú ÎèôÏ†Å ÏÉùÏÑ±
     */
    mapRoomMenuItems() {
        const roomData = this.safeGet(this.data, 'rooms');

        // Í∞ùÏã§ Ï†ÑÏö© ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ (propertyDataMapper.navigateToRoom ÏßÄÏõê)
        const roomClickHandler = (roomId) => {
            if (window.propertyDataMapper?.navigateToRoom) {
                window.propertyDataMapper.navigateToRoom(roomId);
            } else {
                window.location.href = `room.html?id=${roomId}`;
            }
        };

        this._createMenuItems(
            roomData,
            'sub-spaces-',
            'mobile-spaces-items',
            'room.html',
            'Í∞ùÏã§',
            null, // ÏµúÎåÄ Í∞úÏàò Ï†úÌïú ÏóÜÏùå
            roomClickHandler
        );
    }

    /**
     * ÏãúÏÑ§ Î©îÎâ¥ ÏïÑÏù¥ÌÖú ÎèôÏ†Å ÏÉùÏÑ±
     */
    mapFacilityMenuItems() {
        const facilityData = this.safeGet(this.data, 'property.facilities');

        this._createMenuItems(
            facilityData,
            'sub-specials-',
            'mobile-specials-items',
            'facility.html',
            'ÏãúÏÑ§',
            null, // ÏµúÎåÄ Í∞úÏàò Ï†úÌïú ÏóÜÏùå
            null // customClickHandler ÏóÜÏùå
        );
    }

    // ============================================================================
    // ü¶∂ FOOTER MAPPINGS
    // ============================================================================

    /**
     * Footer Î°úÍ≥† Îß§Ìïë
     */
    mapFooterLogo() {
        if (!this.isDataLoaded || !this.data.property) return;

        const property = this.data.property;

        // Footer Î°úÍ≥† Ïù¥ÎØ∏ÏßÄ Îß§Ìïë (data-footer-logo ÏÜçÏÑ± ÏÇ¨Ïö©)
        const footerLogoImage = this.safeSelect('[data-footer-logo]');
        if (footerLogoImage) {
            const logoUrl = ImageHelpers.extractLogoUrl(this.data);

            if (logoUrl) {
                footerLogoImage.onerror = () => {
                    console.warn('‚ö†Ô∏è Ìë∏ÌÑ∞ Î°úÍ≥† Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®');
                    ImageHelpers.applyPlaceholder(footerLogoImage);
                };
                footerLogoImage.src = logoUrl;
                footerLogoImage.alt = property.name || 'Î°úÍ≥†';
                footerLogoImage.classList.remove('empty-image-placeholder');
            } else {
                ImageHelpers.applyPlaceholder(footerLogoImage);
            }
        }

        // Footer Î°úÍ≥† ÌÖçÏä§Ìä∏ Îß§Ìïë
        const footerLogoText = this.safeSelect('[data-footer-logo-text]');
        if (footerLogoText && property.name) {
            footerLogoText.textContent = property.name;
        }
    }

    /**
     * Footer ÏÇ¨ÏóÖÏûê Ï†ïÎ≥¥ Îß§Ìïë
     */
    mapFooterInfo() {
        if (!this.isDataLoaded || !this.data.property) return;

        const property = this.data.property;
        const businessInfo = property.businessInfo;

        if (!businessInfo) {
            return;
        }

        // Ï†ÑÌôîÎ≤àÌò∏ Îß§Ìïë
        const footerPhone = this.safeSelect('[data-footer-phone]');
        if (footerPhone && property.contactPhone) {
            footerPhone.textContent = `ÏàôÏÜå Ï†ÑÌôîÎ≤àÌò∏ : ${property.contactPhone}`;
        }

        // ÎåÄÌëúÏûêÎ™Ö Îß§Ìïë
        const representativeNameElement = this.safeSelect('[data-footer-representative-name]');
        if (representativeNameElement && businessInfo.representativeName) {
            representativeNameElement.textContent = `ÎåÄÌëúÏûêÎ™Ö : ${businessInfo.representativeName}`;
        }

        // Ï£ºÏÜå Îß§Ìïë
        const addressElement = this.safeSelect('[data-footer-address]');
        if (addressElement && businessInfo.businessAddress) {
            addressElement.textContent = `Ï£ºÏÜå : ${businessInfo.businessAddress}`;
        }

        // ÏÇ¨ÏóÖÏûêÎ≤àÌò∏ Îß§Ìïë
        const businessNumberElement = this.safeSelect('[data-footer-business-number]');
        if (businessNumberElement && businessInfo.businessNumber) {
            businessNumberElement.textContent = `ÏÇ¨ÏóÖÏûêÎ≤àÌò∏ : ${businessInfo.businessNumber}`;
        }

        // ÌÜµÏã†ÌåêÎß§ÏóÖÏã†Í≥†Î≤àÌò∏
        const ecommerceElement = this.safeSelect('[data-footer-ecommerce]');
        if (ecommerceElement && businessInfo.eCommerceRegistrationNumber) {
            ecommerceElement.textContent = `ÌÜµÏã†ÌåêÎß§ÏóÖÏã†Í≥†Î≤àÌò∏ : ${businessInfo.eCommerceRegistrationNumber}`;
        }

        // Ï†ÄÏûëÍ∂å Ï†ïÎ≥¥ Îß§Ìïë
        const copyrightElement = this.safeSelect('[data-footer-copyright]');
        if (copyrightElement && businessInfo.businessName) {
            const currentYear = new Date().getFullYear();
            copyrightElement.textContent = `¬© ${currentYear} ${businessInfo.businessName}. All rights reserved.`;
        }
    }

    // ============================================================================
    // üîÑ TEMPLATE METHODS IMPLEMENTATION
    // ============================================================================

    /**
     * Header Ï†ÑÏ≤¥ Îß§Ìïë Ïã§Ìñâ
     */
    async mapHeader() {
        if (!this.isDataLoaded) {
            console.error('Cannot map header: data not loaded');
            return;
        }

        // Favicon Îß§Ìïë
        this.mapFavicon();

        // Header Îß§Ìïë
        this.mapHeaderLogo();
        this.mapHeaderNavigation();
    }

    /**
     * Footer Ï†ÑÏ≤¥ Îß§Ìïë Ïã§Ìñâ
     */
    async mapFooter() {
        if (!this.isDataLoaded) {
            console.error('Cannot map footer: data not loaded');
            return;
        }

        // Footer Îß§Ìïë
        this.mapFooterLogo();
        this.mapFooterInfo();

        // E-commerce registration Îß§Ìïë
        this.mapEcommerceRegistration();
    }

    /**
     * Header & Footer Ï†ÑÏ≤¥ Îß§Ìïë Ïã§Ìñâ
     */
    async mapHeaderFooter() {
        if (!this.isDataLoaded) {
            console.error('Cannot map header/footer: data not loaded');
            return;
        }

        // ÎèôÏãúÏóê Ïã§Ìñâ
        await Promise.all([
            this.mapHeader(),
            this.mapFooter()
        ]);
    }

    /**
     * BaseMapperÏóêÏÑú ÏöîÍµ¨ÌïòÎäî mapPage Î©îÏÑúÎìú Íµ¨ÌòÑ
     */
    async mapPage() {
        return this.mapHeaderFooter();
    }
}

// ES6 Î™®Îìà Î∞è Í∏ÄÎ°úÎ≤å ÎÖ∏Ï∂ú
if (typeof module !== 'undefined' && module.exports) {
    module.exports = HeaderFooterMapper;
} else {
    window.HeaderFooterMapper = HeaderFooterMapper;
}